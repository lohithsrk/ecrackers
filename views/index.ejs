<%-include('partials/header')%>
<section class="mainnn">

<div class="frame1 hide">
  <div class="loginModal">
    <p class="text-center my-5 mx-auto">Login To Continue</p>
    <div class="button redirectHome">  LOGIN  </div>
  </div>
</div>
<div class="frame2 hide">
  <div class="CartModal">
    <p class="text-center my-5 mx-auto">Added to Cart Successfully</p>
    <div class="button addCart">  CLOSE  </div>
    
  </div>
</div>
<div class="frame3 hide">
  <div class="WishlistModal">
    <p class="text-center my-5 mx-auto">Added to wishlist Successfully</p>
    <div class="button addWishlist">  CLOSE  </div>
  </div>
</div>
    <div id="carouselExampleIndicators" class="carousel slide" data-ride="carousel">
  <ol class="carousel-indicators">
    <li data-target="#carouselExampleIndicators" data-slide-to="0" class="active"></li>
    <li data-target="#carouselExampleIndicators" data-slide-to="1"></li>
    <li data-target="#carouselExampleIndicators" data-slide-to="2"></li>
  </ol>

  <div class="carousel-inner">
    <div class="carousel-item active">
      <img  id="cc" class="d-block w-100" src="images/banner/gd.png" alt="First slide">
    </div>
    <div class="carousel-item">
      <img id="cc"  class="d-block w-100" src="images/banner/gdd.png" alt="Second slide">
    </div>
    <div class="carousel-item">
      <img id="cc"  class="d-block w-100" src="images/banner/dg.png" alt="Third slide">
    </div>
  </div>
  <a class="carousel-control-prev" href="#carouselExampleIndicators" role="button" data-slide="prev">
    <span class="carousel-control-prev-icon" aria-hidden="true"></span>
    <span class="sr-only">Previous</span>
  </a>
  <a class="carousel-control-next" href="#carouselExampleIndicators" role="button" data-slide="next">
    <span class="carousel-control-next-icon" aria-hidden="true"></span>
    <span class="sr-only">Next</span>
  </a>
</div>
                    </div>
                </div>
            </div>

            <!-- Slider With Banner Area End Here -->
            <!-- Begin Product Area -->
            <div class="product-area pt-60 pb-50">
                <div class="container">
                    <div class="row">
                        <div class="col-lg-12">
                            <div class="li-product-tab">
<span class="msg" data-msg="<%= user===null?'Login to Continue!':'' %>"></span>

                                <ul class="nav li-product-menu">
                                   <li><a class="active" data-toggle="tab" href="#li-new-product"><span>New Arrival</span></a></li>
                                </ul>
                            </div>
                            <!-- Begin Li's Tab Menu Content Area -->
                        </div>
                    </div>
                    <div class="tab-content">
                        <div id="li-new-product" class="tab-pane active show" role="tabpanel">
                            <div class="row">
                                <div class="product-active owl-carousel">
                                  <% for (let i=0; i<products.length ; i++){%>
                                   <% if(i<6) {%>
                                     <div class="col-lg-12">
                                         <!-- single-product-wrap start -->
                                         <div class="single-product-wrap">
                                             <div class="product-image">
                                                 <a href="/single-product/<%= products[i].id %>">
                                                     <img src=<%= products[i].image %> style="height:200px;" alt="Li's Product Image">
                                                 </a>
                                                 <span class="sticker">New</span>
                                             </div>
                                             <div class="product_desc">
                                                 <div class="product_desc_info">
                                                     <div class="product-review">
                                                         <h5 class="manufacturer">
                                                             <a href="/shop-left-sidebar"><%= products[i].desc %></a>
                                                         </h5>
                                                         <div class="rating-box">
                                                             <ul class="rating">
                                                                <% if (products[i].rating) { %>
                                                                    <% for( let index = 0; index < products[i].rating ; index++ ) { %>
                                                                        <li><i class="fa fa-star-o"></i></li>
                                                                    <% } %>
                                                                <% } %>
                                                                <% if (products[i].negrating) { %>
                                                                    <% for( let index = 0; index < products[i].negrating ; index++ ) { %>
                                                                        <li class="no-star"><i class="fa fa-star-o"></i></li>
                                                                    <% } %>
                                                                <% } %>
                                                             </ul>
                                                         </div>
                                                     </div>
                                                     <h4><a class="product_name" href="/single-product/<%= products[i].id %>"><%= products[i].name %></a></h4>
                                                     <div class="price-box">
                                                        <span class="new-price new-price-2"><%= products[i].discount %></span>
                                                        <span class="old-price"><%= products[i].price %></span>
                                                        <!-- <span class="discount-percentage">-7%</span> -->
                                                    </div>
                                                 </div>
                                                 <div class="add-actions">
                                                     <ul class="add-actions-link">
                                                         <li class="add-cart active"><a href="#" data-uid="<%=user===null?null: user._id %>" class="add-to-cart-link" id="<%= products[i].id %>" >Add to cart</a></li>
                                                         <li onclick="wish('<%= products[i].id %>','<%=user===null?null: user._id %>')"><a class="links-details add-to-wishlist-link" href="#" data-uid="<%=user===null?null: user._id.toLocaleString()%>" class="" id="<%= products[i].id %>"><i class="fa fa-heart-o"></i></a></li>
                                                         <li ><a href="/single-product/<%= products[i].id %>" title="quick view" class="quick-view-btn"><i class="fa fa-eye"></i></a></li>
                                                     </ul>
                                                 </div>
                                             </div>
                                         </div>
                                         <!-- single-product-wrap end -->
                                     </div>
                                     <% } %>
                                  <% } %>
                                    <div class="col-lg-12 ">
                                        <!-- single-product-wrap start -->
                                        <div class="row m-auto align-items-center">
                                          <div class="col m-auto align-items-center">
                                            <a href="/shop-left-sidebar" style="margin:50% auto" class="btn btn-primary shadow-none text-light">See More <i class="fa fa-long-arrow-right px-2 " aria-hidden="true"></i> </a>
                                          </div>
                                        </div>
                                        <!-- single-product-wrap end -->
                                    </div>
                                </div>
                            </div>
                        </div>




                    </div>
                </div>
            </div>
            <!-- Product Area End Here -->
            <!-- Begin Li's Static Banner Area -->
            <div class="li-static-banner">
                <div class="container">
                    <div class="row">
                        <!-- Begin Single Banner Area -->
                        <div class="col-lg-4 col-md-4 text-center">
                            <div class="single-banner">
                                <a href="#">
                                    <img src="images/banner/dg.png" alt="Li's Static Banner">
                                </a>
                            </div>
                        </div>
                        <!-- Single Banner Area End Here -->
                        <!-- Begin Single Banner Area -->
                        <div class="col-lg-4 col-md-4 text-center pt-xs-30">
                            <div class="single-banner">
                                <a href="#">
                                    <img src="images/banner/gdd.png" alt="Li's Static Banner">
                                </a>
                            </div>
                        </div>
                        <!-- Single Banner Area End Here -->
                        <!-- Begin Single Banner Area -->
                        <div class="col-lg-4 col-md-4 text-center pt-xs-30">
                            <div class="single-banner">
                                <a href="#">
                                    <img src="images/banner/gd.png" alt="Li's Static Banner">
                                </a>
                            </div>
                        </div>
                        <!-- Single Banner Area End Here -->
                    </div>
                </div>
            </div>
            <br>
            <br>
                        </div>
                    </div>
                </div>
            </div>
            <br>
            <br>
        </div></section>
        <script src="../js/header.js"></script>

        <script>
            window.onload = async () => {
                const res = await fetch('/cartDetails', {
                    method: 'POST',
                    body: JSON.stringify({ _id: "<%= user===null ? null : user._id %>" }),
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })

                const data = await res.json()
                const cartCount = data.cart.reduce((acc, val) => acc + val.count, 0)
                document.querySelectorAll('.cart-item-count')[1].textContent = cartCount ?? 0
                document.querySelector(".minicart-product-list").innerHTML = data.cart.reduce((acc, product) => {
                    acc += `
                        <li>
                            <a href="/single-product/${product.id}" class="minicart-product-image">
                                <img src="${product.image}" alt="cart products">
                            </a>
                            <div class="minicart-product-details">
                                <h6><a href="/single-product/${product.id}">${product.name}</a></h6>
                                <span>${product.discount} x ${product.count}</span>
                            </div>
                            <button class="close" title="Remove" data-id="${product.id}">
                                <i class="fa fa-close" data-id="${product.id}"></i>
                            </button>
                        </li>`
                    return acc
                }, '')

                const remove = document.querySelectorAll('button.close[data-id]')
                const update = async (e) => {
                    const productID = e.target.getAttribute('data-id');
                    try {
                        const response = await fetch('/remove', {
                            method: 'POST',
                            body: JSON.stringify({ id: productID, _id: "<%=user===null?null: user._id %>" }),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })
                        const details = await response.json()
                        const res = await fetch('/cartDetails', {
                            method: 'POST',
                            body: JSON.stringify({ _id: "<%= user===null ?null: user._id %>" }),
                            headers: {
                                'Content-Type': 'application/json'
                            }
                        })

                        const data = await res.json()
              const cartCount = data.cart.reduce((acc, val) => acc + val.count, 0)
                        document.querySelectorAll('.cart-item-count')[1].textContent = cartCount ?? 0

                        document.querySelector(".minicart-product-list").innerHTML = data.cart.reduce((acc, product) => {
                            acc += `<li>
                                    <a href="/single-product/${product.id}" class="minicart-product-image">
                                        <img src="${product.image}" alt="cart products">
                                    </a>
                                    <div class="minicart-product-details">
                                        <h6 class="productNameResponsive"><a href="/single-product/${product.id}">${product.name}</a></h6>
                                        <span>${product.discount} x ${product.count}</span>
                                    </div>
                                    <button class="close" data-id="${product.id}">
                                        <i class="fa fa-close" data-id="${product.id}"></i>
                                    </button>
                                </li>`
                            return acc
                        }, '')
                        window.location.reload()
                    } catch (e) {
                        alert("Can't remove item from cart")
                    }
                }
                remove.forEach(elmt => {
                    elmt.addEventListener('click', e => {
                      e.preventDefault();
                       update(e)
                    })
                })
            }
            const wishdetails=async()=>{
              const resp = await fetch('/wishlistdetails', {
                          method: 'POST',
                          body: JSON.stringify({ _id: "<%=user===null?null: user._id %>" }),
                  headers: {
                      'Content-Type': 'application/json'
                  }
              })
              const datas = await resp.json()
              const wishlistCount = datas.wishlist.length
              const wishlistIndicateActive = [...document.querySelectorAll('.add-to-wishlist-link')].filter(e => datas.wishlist.map(r => r.id).includes(e.id))
              wishlistIndicateActive.forEach(elmt => {
                  elmt.style.backgroundColor = '#FED700'
                  elmt.style.borderRadius = '5px'
                  elmt.style.color = 'black'
              })
              document.querySelectorAll('.wishlist-item-count')[0].textContent = wishlistCount ?? 0
            }

                                const wish=async(id,uid)=>{
                                  if (document.querySelector('.msg').getAttribute('data-msg').length > 0) {
                                    document.querySelector('.frame1').classList.remove("hide")
                                  document.querySelector('.loginModal').style.display = 'block'
                                  document.querySelector('.redirectHome').addEventListener('click',()=>{window.location.assign("/login-login")})
                              			//alert(document.querySelector('.msg').getAttribute('data-msg'));
                              			return;
                              		}else{
                              			document.querySelector('.frame3').classList.remove("hide")
                              			document.querySelector('.WishlistModal').style.display = 'block'
                              			document.querySelector('.addWishlist').addEventListener('click',()=>{window.location.reload()})
                              			// window.location.reload();
                              		}
                              		//e.preventDefault();
                              		try {
                                    const resp = await fetch('/wishlistUpdate', {
                                        method: 'POST',
                                        body: JSON.stringify({
                                            id,
                                            uid
                                        }),
                                        headers: {
                                            'Content-Type': 'application/json'
                                        }
                                    })
                                    //window.location.reload()
                              		} catch (e) {
                              			console.log({ e });
                              		}
                                }
            window.addEventListener('load',()=>{
                wishdetails()
            })

            document.querySelector('.signout').addEventListener('click',async ()=>{
                const res = await fetch('/signout', {method: 'POST',body:{}})
                window.location.reload()
            })
            document.querySelector('.sign_out_Button1').addEventListener('click',async ()=>{
                  var resultSign = await fetch('/signout', {method: 'POST',body:{}})
                  window.location.reload()
            })

        </script>
<%-include('partials/footer')%>
